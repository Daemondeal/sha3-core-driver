/* Queste prime tre inlcude le userai praticamente sempre*/
#include <linux/kernel.h>
#include <linux/init.h>
#include <linux/module.h>
/* Ci serviranno anche queste */
#include <linux/fs.h>
#include <linux/string.h>
#include <asm/uaccess.h>


/* Standard module information, edit as appropriate */
MODULE_LICENSE("GPL");
MODULE_AUTHOR
    ("Ivan Piri was here");
MODULE_DESCRIPTION
    ("adderdriver - loadable module template generated by petalinux-create -t modules");


/* Variabili statiche */
static char ker_buf[100];
static int curr_len = 0;
static int dev_open(struct inode *inod, struct file *fil);
static ssize_t dev_read(struct file *fil, char *buf, size_t len, loff_t *off);
static ssize_t dev_write(struct file *fil, const char *buf, size_t len, loff_t *off);
static int dev_release(struct inode *inod, struct file *fil);

static struct file_operations fops = {
	.read=dev_read,
	.write=dev_write,
	.open=dev_open,
	.release=dev_release,
};

static int dev_open(struct inode *inod, struct file *fil)
{
	pr_info("Device adderModule opened \n");
	return 0;
}

static int dev_release(struct inode *inod, struct file *fil)
{
	pr_info("Device adderModule closed \n");
	return 0;
}

static ssize_t dev_read(struct file *fil, char *buf, size_t len, loff_t *off)
{
	// Semplicemente copiamo da kernel space a user space
	pr_info("Reading device rx: %d \n", len);
	copy_to_user(buf, ker_buf, curr_len);
	return curr_len; 
}

static ssize_t dev_write(struct file *fil, const char *buf, size_t len, loff_t *off)
{
	// Copiamo da user space a kernel space
	pr_info("Writing device tx: %d \n", len);
	copy_from_user(ker_buf, buf, len);
	ker_buf[len] = 0;
	curr_len = len;
	// Dovresti fare return len ma andrebbe avanti all'infinito
	return 0;
}

/**
 * Stiamo allocando semplicemente un banale char device
 * Per eseguire:
 * - modprobe adderdriver
 * - mknod /dev/nomechevolete c 100 0
 * - echo/cat sul file in /dev/nomechevolete
 * 
 * Stiamo facendo tutto a mano ma c'e' un modo piu' intelligente, guarda il prossimo file
*/
static int init_hello(void)
{
	pr_info("Hello from module adderdriver\n");
	int t = register_chrdev(100, "adderModule", &fops);
	if (t < 0)
	{
		pr_info("Device registration failed\n");
	}
	return 0;
}

static void exit_hello(void)
{
	unregister_chrdev(100, "adderModule");
	pr_info("Goodbye from module adderdriver\n");
}

module_init(init_hello);
module_exit(exit_hello);

